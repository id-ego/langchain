---
description: Flyte는 Kubernetes를 기반으로 한 오픈소스 오케스트레이터로, 데이터 및 ML 파이프라인을 구축하고 LangChain
  실험을 모니터링합니다.
---

# Flyte

> [Flyte](https://github.com/flyteorg/flyte)는 프로덕션급 데이터 및 ML 파이프라인 구축을 용이하게 하는 오픈 소스 오케스트레이터입니다. 
Kubernetes를 기본 플랫폼으로 활용하여 확장성과 재현성을 위해 설계되었습니다.

이 노트북의 목적은 `FlyteCallback`을 Flyte 작업에 통합하여 LangChain 실험을 효과적으로 모니터링하고 추적할 수 있도록 하는 것입니다.

## 설치 및 설정

- `pip install flytekit` 명령어를 실행하여 Flytekit 라이브러리를 설치합니다.
- `pip install flytekitplugins-envd` 명령어를 실행하여 Flytekit-Envd 플러그인을 설치합니다.
- `pip install langchain` 명령어를 실행하여 LangChain을 설치합니다.
- 시스템에 [Docker](https://docs.docker.com/engine/install/)를 설치합니다.

## Flyte 작업

Flyte [작업](https://docs.flyte.org/en/latest/user_guide/basics/tasks.html)은 Flyte의 기본 빌딩 블록 역할을 합니다. 
LangChain 실험을 실행하려면 특정 단계와 작업을 정의하는 Flyte 작업을 작성해야 합니다.

참고: [시작 가이드](https://docs.flyte.org/projects/cookbook/en/latest/index.html)는 Flyte를 로컬에 설치하고 초기 Flyte 파이프라인을 실행하는 방법에 대한 자세한 단계별 지침을 제공합니다.

먼저, LangChain 실험을 지원하기 위해 필요한 종속성을 가져옵니다.

```python
<!--IMPORTS:[{"imported": "AgentType", "source": "langchain.agents", "docs": "https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_types.AgentType.html", "title": "Flyte"}, {"imported": "initialize_agent", "source": "langchain.agents", "docs": "https://api.python.langchain.com/en/latest/agents/langchain.agents.initialize.initialize_agent.html", "title": "Flyte"}, {"imported": "load_tools", "source": "langchain.agents", "docs": "https://api.python.langchain.com/en/latest/agent_toolkits/langchain_community.agent_toolkits.load_tools.load_tools.html", "title": "Flyte"}, {"imported": "FlyteCallbackHandler", "source": "langchain.callbacks", "docs": "https://api.python.langchain.com/en/latest/callbacks/langchain_community.callbacks.flyte_callback.FlyteCallbackHandler.html", "title": "Flyte"}, {"imported": "LLMChain", "source": "langchain.chains", "docs": "https://api.python.langchain.com/en/latest/chains/langchain.chains.llm.LLMChain.html", "title": "Flyte"}, {"imported": "ChatOpenAI", "source": "langchain_openai", "docs": "https://api.python.langchain.com/en/latest/chat_models/langchain_openai.chat_models.base.ChatOpenAI.html", "title": "Flyte"}, {"imported": "PromptTemplate", "source": "langchain_core.prompts", "docs": "https://api.python.langchain.com/en/latest/prompts/langchain_core.prompts.prompt.PromptTemplate.html", "title": "Flyte"}, {"imported": "HumanMessage", "source": "langchain_core.messages", "docs": "https://api.python.langchain.com/en/latest/messages/langchain_core.messages.human.HumanMessage.html", "title": "Flyte"}]-->
import os

from flytekit import ImageSpec, task
from langchain.agents import AgentType, initialize_agent, load_tools
from langchain.callbacks import FlyteCallbackHandler
from langchain.chains import LLMChain
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.messages import HumanMessage
```


OpenAI API 및 Serp API를 활용하기 위해 필요한 환경 변수를 설정합니다:

```python
# Set OpenAI API key
os.environ["OPENAI_API_KEY"] = "<your_openai_api_key>"

# Set Serp API key
os.environ["SERPAPI_API_KEY"] = "<your_serp_api_key>"
```


`<your_openai_api_key>` 및 `<your_serp_api_key>`를 OpenAI 및 Serp API에서 얻은 각각의 API 키로 교체합니다.

파이프라인의 재현성을 보장하기 위해 Flyte 작업은 컨테이너화됩니다. 
각 Flyte 작업은 Flyte [워크플로우](https://docs.flyte.org/en/latest/user_guide/basics/workflows.html) 전체에서 공유되거나 각 작업에 대해 별도로 제공될 수 있는 이미지와 연결되어야 합니다.

각 Flyte 작업에 필요한 종속성을 제공하는 프로세스를 간소화하기 위해 [`ImageSpec`](https://docs.flyte.org/en/latest/user_guide/customizing_dependencies/imagespec.html) 객체를 초기화할 수 있습니다. 
이 접근 방식은 자동으로 Docker 빌드를 트리거하여 사용자가 수동으로 Docker 이미지를 생성할 필요를 줄입니다.

```python
custom_image = ImageSpec(
    name="langchain-flyte",
    packages=[
        "langchain",
        "openai",
        "spacy",
        "https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.5.0/en_core_web_sm-3.5.0.tar.gz",
        "textstat",
        "google-search-results",
    ],
    registry="<your-registry>",
)
```


Docker 이미지를 원하는 레지스트리에 푸시할 수 있는 유연성이 있습니다. 
[Docker Hub](https://hub.docker.com/) 또는 [GitHub Container Registry (GHCR)](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)는 시작하기에 편리한 옵션입니다.

레지스트리를 선택한 후, LangChain 메트릭을 Flyte Deck에 기록하는 Flyte 작업을 생성할 수 있습니다.

다음 예제는 OpenAI LLM, 체인 및 도구가 있는 에이전트와 관련된 작업을 보여줍니다:

### LLM

```python
@task(disable_deck=False, container_image=custom_image)
def langchain_llm() -> str:
    llm = ChatOpenAI(
        model_name="gpt-3.5-turbo",
        temperature=0.2,
        callbacks=[FlyteCallbackHandler()],
    )
    return llm.invoke([HumanMessage(content="Tell me a joke")]).content
```


### Chain

```python
@task(disable_deck=False, container_image=custom_image)
def langchain_chain() -> list[dict[str, str]]:
    template = """You are a playwright. Given the title of play, it is your job to write a synopsis for that title.
Title: {title}
Playwright: This is a synopsis for the above play:"""
    llm = ChatOpenAI(
        model_name="gpt-3.5-turbo",
        temperature=0,
        callbacks=[FlyteCallbackHandler()],
    )
    prompt_template = PromptTemplate(input_variables=["title"], template=template)
    synopsis_chain = LLMChain(
        llm=llm, prompt=prompt_template, callbacks=[FlyteCallbackHandler()]
    )
    test_prompts = [
        {
            "title": "documentary about good video games that push the boundary of game design"
        },
    ]
    return synopsis_chain.apply(test_prompts)
```


### Agent

```python
@task(disable_deck=False, container_image=custom_image)
def langchain_agent() -> str:
    llm = OpenAI(
        model_name="gpt-3.5-turbo",
        temperature=0,
        callbacks=[FlyteCallbackHandler()],
    )
    tools = load_tools(
        ["serpapi", "llm-math"], llm=llm, callbacks=[FlyteCallbackHandler()]
    )
    agent = initialize_agent(
        tools,
        llm,
        agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
        callbacks=[FlyteCallbackHandler()],
        verbose=True,
    )
    return agent.run(
        "Who is Leonardo DiCaprio's girlfriend? Could you calculate her current age and raise it to the power of 0.43?"
    )
```


이 작업들은 Flyte 내에서 LangChain 실험을 실행하기 위한 출발점 역할을 합니다.

## Kubernetes에서 Flyte 작업 실행

구성된 Flyte 백엔드에서 Flyte 작업을 실행하려면 다음 명령어를 사용합니다:

```bash
pyflyte run --image <your-image> langchain_flyte.py langchain_llm
```


이 명령어는 Flyte 백엔드에서 `langchain_llm` 작업의 실행을 시작합니다. 나머지 두 작업도 유사한 방식으로 트리거할 수 있습니다.

메트릭은 Flyte UI에 다음과 같이 표시됩니다:

![Flyte Deck에서 LangChain 메트릭과 종속성 트리 시각화를 보여주는 스크린샷.](https://ik.imagekit.io/c8zl7irwkdda/Screenshot_2023-06-20_at_1.23.29_PM_MZYeG0dKa.png?updatedAt=1687247642993 "Flyte Deck 메트릭 표시")