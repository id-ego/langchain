---
description: 이 문서는 Modal 생태계를 사용하여 LangChain 사용자 정의 LLM을 실행하는 방법을 다룹니다. 설치, 웹 엔드포인트
  배포 및 사용법을 설명합니다.
---

# 모달

이 페이지에서는 LangChain 커스텀 LLM을 실행하기 위해 모달 생태계를 사용하는 방법을 다룹니다.
두 부분으로 나뉘어 있습니다:

1. 모달 설치 및 웹 엔드포인트 배포
2. `LLM` 래퍼 클래스를 사용하여 배포된 웹 엔드포인트 사용하기.

## 설치 및 설정

- `pip install modal`로 설치
- `modal token new` 실행

## 모달 함수 및 웹훅 정의

프롬프트를 포함해야 합니다. 엄격한 응답 구조가 있습니다:

```python
class Item(BaseModel):
    prompt: str

@stub.function()
@modal.web_endpoint(method="POST")
def get_text(item: Item):
    return {"prompt": run_gpt2.call(item.prompt)}
```


다음은 GPT2 모델의 예입니다:

```python
from pydantic import BaseModel

import modal

CACHE_PATH = "/root/model_cache"

class Item(BaseModel):
    prompt: str

stub = modal.Stub(name="example-get-started-with-langchain")

def download_model():
    from transformers import GPT2Tokenizer, GPT2LMHeadModel
    tokenizer = GPT2Tokenizer.from_pretrained('gpt2')
    model = GPT2LMHeadModel.from_pretrained('gpt2')
    tokenizer.save_pretrained(CACHE_PATH)
    model.save_pretrained(CACHE_PATH)

# Define a container image for the LLM function below, which
# downloads and stores the GPT-2 model.
image = modal.Image.debian_slim().pip_install(
    "tokenizers", "transformers", "torch", "accelerate"
).run_function(download_model)

@stub.function(
    gpu="any",
    image=image,
    retries=3,
)
def run_gpt2(text: str):
    from transformers import GPT2Tokenizer, GPT2LMHeadModel
    tokenizer = GPT2Tokenizer.from_pretrained(CACHE_PATH)
    model = GPT2LMHeadModel.from_pretrained(CACHE_PATH)
    encoded_input = tokenizer(text, return_tensors='pt').input_ids
    output = model.generate(encoded_input, max_length=50, do_sample=True)
    return tokenizer.decode(output[0], skip_special_tokens=True)

@stub.function()
@modal.web_endpoint(method="POST")
def get_text(item: Item):
    return {"prompt": run_gpt2.call(item.prompt)}
```


### 웹 엔드포인트 배포

[`modal deploy`](https://modal.com/docs/reference/cli/deploy) CLI 명령어를 사용하여 모달 클라우드에 웹 엔드포인트를 배포합니다.
귀하의 웹 엔드포인트는 `modal.run` 도메인 아래에 지속적인 URL을 획득합니다.

## 모달 웹 엔드포인트 주위의 LLM 래퍼

배포된 웹 엔드포인트의 URL을 수용할 `Modal` LLM 래퍼 클래스입니다.

```python
<!--IMPORTS:[{"imported": "Modal", "source": "langchain_community.llms", "docs": "https://api.python.langchain.com/en/latest/llms/langchain_community.llms.modal.Modal.html", "title": "Modal"}]-->
from langchain_community.llms import Modal

endpoint_url = "https://ecorp--custom-llm-endpoint.modal.run"  # REPLACE ME with your deployed Modal web endpoint's URL

llm = Modal(endpoint_url=endpoint_url)
llm_chain = LLMChain(prompt=prompt, llm=llm)

question = "What NFL team won the Super Bowl in the year Justin Beiber was born?"

llm_chain.run(question)
```